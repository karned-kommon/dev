@version: current
@include "scl.conf"

# Add a global log_fifo_size to avoid window-sizing warnings when using TCP sources
options {
    log_fifo_size(20000);
};

# Sources de logs
source s_network_tcp {
    network(
        transport("tcp")
        port(514)
        max-connections(100)
        log-iw-size(1000)
    );
};

source s_network_udp {
    network(
        transport("udp")
        port(514)
    );
};

source s_system {
    system();
};

# Templates pour formatage des logs
template t_file_template {
    template("${R_YEAR}-${R_MONTH}-${R_DAY} ${R_HOUR}:${R_MIN}:${R_SEC} ${HOST} ${PROGRAM}[${PID}]: ${MSGONLY}\n");
};

template t_json_template {
    template("$(format-json --scope rfc3164 --scope nv-pairs --exclude R_DATE --key ISODATE @timestamp=${ISODATE})\n");
};

# Destinations pour les logs
destination d_all_logs {
    # For development: write all logs to stdout so `docker logs` shows them in real time
    file("/dev/stdout" template(t_file_template));
};

destination d_mongodb {
    file("/var/log/karned-mongodb.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_redis {
    file("/var/log/karned-redis.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_keycloak {
    file("/var/log/karned-keycloak.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_vault {
    file("/var/log/karned-vault.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_api_services {
    file("/var/log/karned-api-services.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_elasticsearch {
    file("/var/log/karned-elasticsearch.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_kafka {
    file("/var/log/karned-kafka.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_grafana {
    file("/var/log/karned-grafana.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_prometheus {
    file("/var/log/karned-prometheus.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_minio {
    file("/var/log/karned-minio.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_mariadb {
    file("/var/log/karned-mariadb.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_postgres {
    file("/var/log/karned-postgres.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_neo4j {
    file("/var/log/karned-neo4j.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_couchdb {
    file("/var/log/karned-couchdb.log" 
         template(t_file_template)
         create_dirs(yes));
};

destination d_init {
    file("/var/log/karned-init.log" 
         template(t_file_template)
         create_dirs(yes));
};


# Filtres par service
filter f_mongodb { match("mongodb" value("PROGRAM")); };
filter f_redis { match("redis" value("PROGRAM")); };
filter f_keycloak { match("keycloak" value("PROGRAM")); };
filter f_vault { match("vault" value("PROGRAM")) or match("vault-unseal" value("PROGRAM")); };
filter f_elasticsearch { match("elasticsearch" value("PROGRAM")); };
filter f_kafka { match("kafka" value("PROGRAM")) or match("kafka-ui" value("PROGRAM")); };
filter f_grafana { match("grafana" value("PROGRAM")); };
filter f_prometheus { match("prometheus" value("PROGRAM")); };
filter f_minio { match("minio" value("PROGRAM")); };
filter f_mariadb { match("mariadb" value("PROGRAM")); };
filter f_postgres { match("postgres" value("PROGRAM")); };
filter f_neo4j { match("neo4j" value("PROGRAM")); };
filter f_couchdb { match("couchdb" value("PROGRAM")); };
filter f_init { match("init" value("PROGRAM")); };
filter f_api_services { 
    match("api-" value("PROGRAM")) or 
    match("ms-" value("PROGRAM")); 
};

# Règles de routage des logs
log {
    source(s_network_tcp);
    source(s_network_udp);
    source(s_system);
    
    # For development: send all logs to stdout (human readable)
    destination(d_all_logs);
    
    # Logs spécifiques par service
    if (filter(f_mongodb)) {
        destination(d_mongodb);
    } elif (filter(f_redis)) {
        destination(d_redis);
    } elif (filter(f_keycloak)) {
        destination(d_keycloak);
    } elif (filter(f_vault)) {
        destination(d_vault);
    } elif (filter(f_elasticsearch)) {
        destination(d_elasticsearch);
    } elif (filter(f_kafka)) {
        destination(d_kafka);
    } elif (filter(f_grafana)) {
        destination(d_grafana);
    } elif (filter(f_prometheus)) {
        destination(d_prometheus);
    } elif (filter(f_minio)) {
        destination(d_minio);
    } elif (filter(f_mariadb)) {
        destination(d_mariadb);
    } elif (filter(f_postgres)) {
        destination(d_postgres);
    } elif (filter(f_neo4j)) {
        destination(d_neo4j);
    } elif (filter(f_couchdb)) {
        destination(d_couchdb);
    } elif (filter(f_init)) {
        destination(d_init);
    } elif (filter(f_api_services)) {
        destination(d_api_services);
    };
};

# Logs statistiques internes de syslog-ng
log {
    source(s_system);
    destination(d_all_logs);
};